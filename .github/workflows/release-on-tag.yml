# 文件路径: .github/workflows/release-on-tag.yml

name: Build and Release gltf-viewer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build and Release for Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install CMake and Python
        uses: jwlawson/actions-setup-cmake@v2.0
        with:
          cmake-version: '3.22.x'
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Configure CMake
        run: >
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=Release
          -DFILAMENT_ENABLE_JAVA=OFF
          -DFILAMENT_SKIP_SAMPLES=ON
          -DFILAMENT_ENABLE_TOOLS=ON

      - name: Build gltf-viewer
        run: cmake --build build --target gltf-viewer --config Release -j

      - name: Prepare package for Release
        shell: bash
        run: |
          mkdir package
          cp build/tools/gltf-viewer/gltf-viewer.exe package/
          cp build/bin/*.dll package/
          echo "gltf-viewer with custom object rotation." > package/readme.txt
          echo "Unzip and double-click gltf-viewer.exe to run." >> package/readme.txt
          VERSION_NAME=${{ github.ref_name }}
          zip -r "gltf-viewer-${VERSION_NAME}-windows.zip" package

      - name: Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          files: "gltf-viewer-*-windows.zip"
          generate_release_notes: true